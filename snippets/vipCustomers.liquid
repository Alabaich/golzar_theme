<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 1. LIQUID INJECTION
    var customerId = "{{ customer.id }}";
    var customerTags = {{ customer.tags | json | default: "[]" }};

    // FIX: Use Unicode for curly braces to bypass Shopify strict validation
    var isPreview = customerId.includes("\u007B\u007B"); 
    
    if (isPreview) {
      console.log("⚠️ Preview Mode detected.");
      customerTags = ["VIP"]; 
    }

    // 2. CHECK VIP STATUS
    if (customerTags.includes("VIP")) {
       document.body.classList.add("vip-member");
       initVipPricing();
    }

    function initVipPricing() {
      // TARGET ONLY .price__container
      const priceContainers = document.querySelectorAll('.price__container');

      priceContainers.forEach(container => {
        let observer; // Define variable outside

        const updatePrice = () => {
          // 1. PAUSE OBSERVER (Prevents infinite loops)
          if (observer) observer.disconnect();

          try {
            // Find Sale Price first
            let originalPriceEl = container.querySelector('.price-item--sale');
            
            // Fallback to regular if sale not found/visible
            if (!originalPriceEl || originalPriceEl.offsetParent === null) {
               originalPriceEl = container.querySelector('.price-item--regular');
            }

            // Only proceed if we found a valid price element
            if (originalPriceEl) {
              const originalText = originalPriceEl.innerText.trim();
              
              if (originalText) {
                // Parse Price
                const currencySymbol = originalText.replace(/[0-9.,]/g, '').trim();
                const cleanNumString = originalText.replace(/[^0-9.]/g, '');
                const priceValue = parseFloat(cleanNumString);

                if (!isNaN(priceValue)) {
                  // Calculate 15% Off
                  const vipPriceValue = (priceValue * 0.85).toFixed(2);
                  const newHtml = `Pro Price <span class="vip-amount">${currencySymbol}${vipPriceValue}</span>`;

                  // Find or Create VIP Element
                  let vipEl = container.querySelector('.vip-pro-price');
                  if (!vipEl) {
                    vipEl = document.createElement('div');
                    vipEl.className = 'vip-pro-price';
                    container.appendChild(vipEl);
                  }

                  // Update content
                  if (vipEl.innerHTML !== newHtml) {
                     vipEl.innerHTML = newHtml;
                  }
                }
              }
            }
          } catch (e) {
            console.error("VIP Price Error:", e);
          } finally {
            // 2. RESUME OBSERVER (Crucial: Always runs, even if price was missing momentarily)
            if (observer) {
              observer.observe(container, { 
                subtree: true, 
                childList: true, 
                characterData: true 
              });
            }
          }
        };

        // Initialize Observer
        observer = new MutationObserver((mutations) => {
          let shouldUpdate = false;
          
          for (const mutation of mutations) {
            // Ignore changes to our own VIP element to prevent loops
            if (mutation.target.classList && mutation.target.classList.contains('vip-pro-price')) continue;
            if (mutation.target.closest && mutation.target.closest('.vip-pro-price')) continue;
            
            shouldUpdate = true;
          }

          if (shouldUpdate) updatePrice();
        });

        // Run immediately
        updatePrice();
        
        // Start Observing
        observer.observe(container, { 
          subtree: true, 
          childList: true, 
          characterData: true 
        });
      });
    }
  });
</script>

<style>
  /* Style the new VIP Price */
  .vip-pro-price {
    color: #d9534f;
    font-weight: bold;
    font-size: 1.1em;
    margin-top: 4px; 
  }
</style>