<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 1. LIQUID INJECTION
    var customerId = "{{ customer.id }}";
    var customerTags = {{ customer.tags | json | default: "[]" }};

    // FIX: Use Unicode for curly braces to bypass Shopify strict validation
    var isPreview = customerId.includes("\u007B\u007B"); 
    
    if (isPreview) {
      console.log("⚠️ Preview Mode detected.");
      customerTags = ["VIP"]; 
    }

    // 2. CHECK VIP STATUS
    if (customerTags.includes("VIP")) {
       document.body.classList.add("vip-member");
       initVipPricing();
    }

    function initVipPricing() {
      // TARGET ONLY .price__container
      const priceContainers = document.querySelectorAll('.price__container');

      priceContainers.forEach(container => {
        
        const updatePrice = () => {
          // Prioritize Sale Price to calculate discount on the ACTUAL selling price
          let originalPriceEl = container.querySelector('.price-item--sale');
          
          // Fallback to regular price if sale price isn't visible/found
          if (!originalPriceEl || originalPriceEl.offsetParent === null) {
             originalPriceEl = container.querySelector('.price-item--regular');
          }

          if (!originalPriceEl) return;

          // Get the text
          const originalText = originalPriceEl.innerText.trim();
          if (!originalText) return;

          // Parse Price
          const currencySymbol = originalText.replace(/[0-9.,]/g, '').trim();
          const cleanNumString = originalText.replace(/[^0-9.]/g, '');
          const priceValue = parseFloat(cleanNumString);

          if (isNaN(priceValue)) return;

          // Calculate 15% Off
          const vipPriceValue = (priceValue * 0.85).toFixed(2);
          const newHtml = `Pro Price <span class="vip-amount">${currencySymbol}${vipPriceValue}</span>`;

          // Find or Create VIP Element
          let vipEl = container.querySelector('.vip-pro-price');
          if (!vipEl) {
            vipEl = document.createElement('div');
            vipEl.className = 'vip-pro-price';
            container.appendChild(vipEl);
          }

          // Update only if changed (prevents loop)
          if (vipEl.innerHTML !== newHtml) {
             vipEl.innerHTML = newHtml;
          }
        };

        // Run immediately
        updatePrice();

        // OBSERVE CHANGES SAFELY
        const observer = new MutationObserver((mutations) => {
          let shouldUpdate = false;
          
          for (const mutation of mutations) {
            // STOP THE LOOP: Ignore changes to our own VIP element
            if (mutation.target.classList && mutation.target.classList.contains('vip-pro-price')) continue;
            if (mutation.target.closest && mutation.target.closest('.vip-pro-price')) continue;
            
            shouldUpdate = true;
          }

          if (shouldUpdate) updatePrice();
        });

        observer.observe(container, { 
          subtree: true, 
          childList: true, 
          characterData: true 
        });
      });
    }
  });
</script>

<style>
  /* REMOVED the rule that hid the original price. Now both show. */

  /* Style the new VIP Price */
  .vip-pro-price {
    color: #d9534f;
    font-weight: bold;
    font-size: 1.1em;
    margin-top: 4px; /* Add some spacing between regular price and pro price */
  }
</style>