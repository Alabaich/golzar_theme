<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 1. LIQUID INJECTION
    var customerId = "{{ customer.id }}";
    var customerTags = {{ customer.tags | json | default: "[]" }};

    // FIX: Use Unicode for curly braces to bypass Shopify strict validation
    // This prevents the "Liquid syntax error" during deployment
    var isPreview = customerId.includes("\u007B\u007B"); 
    
    if (isPreview) {
      console.log("⚠️ Preview Mode detected.");
      customerTags = ["VIP"]; 
    }

    // 2. CHECK VIP STATUS
    if (customerTags.includes("VIP")) {
       document.body.classList.add("vip-member");
       initVipPricing();
    }

    function initVipPricing() {
      const priceContainers = document.querySelectorAll('.price, .price__container, .product__info-container .price');

      priceContainers.forEach(container => {
        
        const updatePrice = () => {
          // Find the Regular or Sale price element
          const originalPriceEl = container.querySelector('.price-item--sale, .price-item--regular');
          if (!originalPriceEl) return;

          // Get the text
          const originalText = originalPriceEl.innerText.trim();
          if (!originalText) return;

          // Parse Price
          const currencySymbol = originalText.replace(/[0-9.,]/g, '').trim();
          const cleanNumString = originalText.replace(/[^0-9.]/g, '');
          const priceValue = parseFloat(cleanNumString);

          if (isNaN(priceValue)) return;

          // Calculate 15% Off
          const vipPriceValue = (priceValue * 0.85).toFixed(2);
          const newHtml = `Pro Price <span class="vip-amount">${currencySymbol}${vipPriceValue}</span>`;

          // Find or Create VIP Element
          let vipEl = container.querySelector('.vip-pro-price');
          if (!vipEl) {
            vipEl = document.createElement('div');
            vipEl.className = 'vip-pro-price';
            container.appendChild(vipEl);
          }

          // LOOP PREVENTION: Only update DOM if values are actually different
          if (vipEl.innerHTML !== newHtml) {
             vipEl.innerHTML = newHtml;
          }
        };

        // Run immediately
        updatePrice();

        // OBSERVE CHANGES SAFELY
        const observer = new MutationObserver((mutations) => {
          let shouldUpdate = false;
          
          for (const mutation of mutations) {
            // STOP THE LOOP: If the change happened inside our VIP element, ignore it.
            if (mutation.target.classList && mutation.target.classList.contains('vip-pro-price')) continue;
            if (mutation.target.closest && mutation.target.closest('.vip-pro-price')) continue;
            
            // Only update if the original price changed
            shouldUpdate = true;
          }

          if (shouldUpdate) updatePrice();
        });

        observer.observe(container, { 
          subtree: true, 
          childList: true, 
          characterData: true 
        });
      });
    }
  });
</script>

<style>
  /* 1. Hide the original price for VIPs */
  body.vip-member .price-item--regular,
  body.vip-member .price-item--sale {
    display: none !important;
  }

  /* 2. Style the new VIP Price */
  .vip-pro-price {
    color: #d9534f;
    font-weight: bold;
    font-size: 1.2em;
    margin-top: 5px;
  }
</style>