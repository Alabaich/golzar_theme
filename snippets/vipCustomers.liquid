<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 1. LIQUID INJECTION
    var customerId = "{{ customer.id }}";
    var customerTags = {{ customer.tags | json | default: "[]" }};

    // FIX: Use Unicode for curly braces to bypass Shopify strict validation
    var isPreview = customerId.includes("\u007B\u007B"); 
    
    if (isPreview) {
      console.log("⚠️ Preview Mode detected.");
      customerTags = ["VIP"]; 
    }

    // 2. CHECK VIP STATUS
    if (customerTags.includes("VIP")) {
       document.body.classList.add("vip-member");
       initVipPricing();
    }

    function initVipPricing() {
      // --- CORE UPDATE FUNCTION ---
      const updateAllPrices = () => {
        const priceContainers = document.querySelectorAll('.price__container');

        priceContainers.forEach(container => {
          try {
            // Find Sale Price first
            let originalPriceEl = container.querySelector('.price-item--sale');
            
            // Fallback to regular if sale not found/visible
            if (!originalPriceEl || originalPriceEl.offsetParent === null) {
               originalPriceEl = container.querySelector('.price-item--regular');
            }

            if (!originalPriceEl) return;

            const originalText = originalPriceEl.innerText.trim();
            if (!originalText) return;

            // Parse Price
            const currencySymbol = originalText.replace(/[0-9.,]/g, '').trim();
            const cleanNumString = originalText.replace(/[^0-9.]/g, '');
            const priceValue = parseFloat(cleanNumString);

            if (isNaN(priceValue)) return;

            // Calculate 15% Off
            const vipPriceValue = (priceValue * 0.85).toFixed(2);
            const newHtml = `Pro Price <span class="vip-amount">${currencySymbol}${vipPriceValue}</span>`;

            // Find or Create VIP Element
            let vipEl = container.querySelector('.vip-pro-price');
            if (!vipEl) {
              vipEl = document.createElement('div');
              vipEl.className = 'vip-pro-price';
              container.appendChild(vipEl);
            }

            // Update content ONLY if changed (Micro-optimization)
            if (vipEl.innerHTML !== newHtml) {
               vipEl.innerHTML = newHtml;
            }
          } catch (e) {
            console.error("VIP Price Error:", e);
          }
        });
      };

      // --- TRIGGER LOGIC ---

      // 1. Run Immediately
      updateAllPrices();

      // 2. Listen for URL Changes (Variant switching usually changes URL parameters)
      let lastUrl = location.href; 
      new MutationObserver(() => {
        const url = location.href;
        if (url !== lastUrl) {
          lastUrl = url;
          // URL changed, wait a tiny bit for Shopify to render new price, then update
          setTimeout(updateAllPrices, 100);
          setTimeout(updateAllPrices, 500); // Backup retry
        }
      }).observe(document, {subtree: true, childList: true});

      // 3. Fallback Interval (Checks every 1 second to catch anything missed)
      // This is lightweight because updateAllPrices checks efficiently
      setInterval(updateAllPrices, 1000);
    }
  });
</script>

<style>
  /* Style the new VIP Price */
  .vip-pro-price {
    color: #d9534f;
    font-weight: bold;
    font-size: 1.1em;
    margin-top: 4px; 
  }
</style>